#!groovy
import org.folio.Constants
import org.folio.models.*
import org.folio.rest.GitHubUtility
import org.jenkinsci.plugins.workflow.libs.Library

//TODO remove branch before merge to master
@Library('pipelines-shared-library@RANCHER-1359-test') _

properties([
  buildDiscarder(logRotator(numToKeepStr: '30')),
//  disableConcurrentBuilds(),
  parameters([
    folioParameters.cluster(),
    folioParameters.namespace(),
    string(name: 'TENANT_ID', defaultValue: '', description: '(Required) Tenant ID for building UI'),
    booleanParam(name: 'CONSORTIA', defaultValue: false, description: '(Optional) Enable Consortia'),
    folioParameters.branch(),
    folioParameters.configType(),
    folioParameters.agent(),
    folioParameters.refreshParameters()
  ])
])

if (params.REFRESH_PARAMETERS) {
  currentBuild.result = 'ABORTED'
  return
}
ansiColor('xterm') {
  node(params.AGENT) {
    try {
      stage('Ini') {
        cleanWs()
        buildName "${params.CLUSTER}-${params.NAMESPACE}.${env.BUILD_ID}"
        buildDescription "Branch: ${params.FOLIO_BRANCH}\nConfig: ${params.CONFIG_TYPE}"
      }
      String folioRepository = 'application-descriptors'
      boolean releaseVersion = true
      RancherNamespace namespace = new RancherNamespace("${params.CLUSTER}", "${params.NAMESPACE}")
      namespace.setDefaultTenantId("${params.TENANT_ID}")
      namespace.withDeploymentConfigType('testing')
      namespace.addDeploymentConfig('RANCHER-1359-test')
      String commitHash = common.getLastCommitHash('platform-complete', 'snapshot')
      List installJson = new GitHubUtility(this).getEnableList(folioRepository, "${params.FOLIO_BRANCH}")
      TenantUi tenantUi = new TenantUi("${namespace.getClusterName()}-${namespace.getNamespaceName()}",
        "${commitHash}", "${params.FOLIO_BRANCH}")
      namespace.addTenant(folioDefault.tenants()[namespace.getDefaultTenantId()]
        .withInstallJson(namespace.getModules().getInstallJson().collect())
        .withIndex(new Index(true, true))
        .withTenantUi(tenantUi.clone())
      )
      namespace.getModules().setInstallJson(installJson)

      stage('Build and deploy UI') {
        def jobParameters = [eureka              : true,
                             kongUrl             : "https://${params.CLUSTER}-${params.NAMESPACE}-kong.${Constants.CI_ROOT_DOMAIN}",
                             keycloakUrl         : "https://${params.CLUSTER}-${params.NAMESPACE}-keycloak.${Constants.CI_ROOT_DOMAIN}",
                             tenantUrl           : "https://${params.CLUSTER}-${params.NAMESPACE}-${params.TENANT_ID}.${Constants.CI_ROOT_DOMAIN}",
                             hasAllPerms         : false,
                             isSingleTenant      : true,
                             tenantOptions       : """{${params.TENANT_ID}: {name: "${params.TENANT_ID}", clientId: "${params.TENANT_ID}-application"}}""",
                             tenantId            : "${params.TENANT_ID}",
                             custom_hash         : commitHash,
                             custom_url          : "https://${params.CLUSTER}-${params.NAMESPACE}-kong.${Constants.CI_ROOT_DOMAIN}",
                             custom_tag          : commitHash.toString().take(7),
                             consortia           : params.CONSORTIA,
                             clientId            : "${params.TENANT_ID}" + "-application",
                             rancher_cluster_name: params.CLUSTER,
                             rancher_project_name: params.NAMESPACE,
                             folio_branch        : params.FOLIO_BRANCH]
        uiBuild(jobParameters, releaseVersion)
        folioHelm.withKubeConfig(namespace.getClusterName()) {
          folioHelm.deployFolioModule(namespace, 'ui-bundle', "${params.CLUSTER}-${params.NAMESPACE}.${params.TENANT_ID}.${commitHash.toString().take(7)}", false, "${params.TENANT_ID}")
        }
      }
    } catch (e) {
      println "Caught exception: ${e}"
      error(e.getMessage())
    } finally {
      stage('Cleanup') {
        cleanWs notFailBuild: true
      }
    }
  }
}
