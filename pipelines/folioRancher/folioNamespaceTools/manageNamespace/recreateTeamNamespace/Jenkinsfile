#!groovy
import groovy.transform.Field
import org.folio.Constants
import org.folio.jenkins.PodTemplates
import org.folio.models.parameters.CreateNamespaceParameters
import org.folio.rest_v2.PlatformType
import org.folio.utilities.GitHubClient
import org.jenkinsci.plugins.workflow.libs.Library

//TODO remove branch before merge to master
@Library('pipelines-shared-library') _

@Field final String deleteNamespaceJobName = Constants.JENKINS_DELETE_NAMESPACE_JOB
@Field final String createNamespaceJobName = Constants.JENKINS_CREATE_NAMESPACE_FROM_BRANCH_JOB

properties([
  buildDiscarder(logRotator(numToKeepStr: '30')),
  disableConcurrentBuilds(),
  parameters([folioParameters.platform(),
              folioParameters.cluster('PLATFORM'),
              folioParameters.namespace(),
              folioParameters.platformBranch(),
              folioParameters.configType(),
              booleanParam(name: 'SC_NATIVE', defaultValue: true, description: '(Optional) Set false to use Java based SC image'),
              booleanParam(name: 'CONSORTIA_EXTRA', defaultValue: false, description: '(Optional) Set true to include 2nd consortium'),
              folioParameters.refreshParameters()]),
  pipelineTriggers([
    parameterizedCron('''
      H 20 * * * %PLATFORM=EUREKA;CLUSTER=folio-edev;NAMESPACE=eureka;CONFIG_TYPE=development
    ''')])
])
// Get back when the ticket is resolved https://folio-org.atlassian.net/browse/RANCHER-1546
//            pipelineTriggers([parameterizedCron('''
//              H 20 * * * %CLUSTER=folio-edev;NAMESPACE=eureka;EUREKA=true;CONFIG_TYPE=development;AGENT=rancher
//            ''')])])


if (params.REFRESH_PARAMETERS) {
  currentBuild.result = 'ABORTED'
  return
}

PodTemplates podTemplates = new PodTemplates(this)

CreateNamespaceParameters namespace = new CreateNamespaceParameters.Builder()
  .platform(PlatformType.EUREKA)
  .clusterName(params.CLUSTER)
  .namespaceName(params.NAMESPACE)
  .folioBranch('snapshot')
  .platformBranch(params.PLATFORM_BRANCH)
  .okapiVersion('latest')
  .configType(params.CONFIG_TYPE)
  .loadReference(true)
  .loadSample(true)
  .consortia(true)
  .consortiaExtra(params.CONSORTIA_EXTRA)
  .linkedData(true)
  .rwSplit(false)
  .greenmail(false)
  .mockServer(false)
  .rtr(false)
  .splitFiles(true)
  .ecsCCL(false)
  .hasSecureTenant(true)
  .secureTenantId(folioDefault.consortiaTenants().get('university').getTenantId())
  .dataset(false)
  .pgType('built-in')
  .pgVersion('16.8')
  .kafkaType('built-in')
  .opensearchType('aws')
  .scNative(params.SC_NATIVE)
  .s3Type('built-in')
  .uiBuild(true)
  .runSanityCheck(true)
  .build()

ansiColor('xterm') {
  podTemplates.rancherAgent {
    stage('Checkout') {
      checkout scm
    }

    stage('Fetch Applications') {
      Map platformDescriptor = new GitHubClient(this).getRepoFileContent('platform-lsp', params.PLATFORM_BRANCH, 'platform-descriptor.json') as Map

      List appNames = platformDescriptor.applications?.required?.collect { it.name } ?: []
      appNames += platformDescriptor.applications?.optional?.collect { it.name } ?: []

      println "Found ${appNames.size()} applications in platform-descriptor.json"

      namespace.applications = appNames as List<String>
    }

    stage('Build name') {
      buildName "${namespace.getClusterName()}-${namespace.getNamespaceName()}.${env.BUILD_ID}"
      buildDescription "Config: ${params.CONFIG_TYPE}"
    }

    stage('Cleaning env') {
      folioTriggerJob.deleteNamespace(deleteNamespaceJobName, namespace)
    }

    stage('Spinning up env') {
      folioTriggerJob.createNamespaceFromBranch(createNamespaceJobName, namespace)
    }
  }
}
