#!groovy
@Library('pipelines-shared-library@RANCHER-1148') _

CONFIG_BRANCH = 'RANCHER-1148'

import org.folio.Constants
import org.jenkinsci.plugins.workflow.libs.Library
import java.time.LocalDateTime
import org.folio.rest.model.OkapiUser

properties([
  buildDiscarder(logRotator(numToKeepStr: '20')),
  parameters([
    folioParameters.cluster(),
    folioParameters.namespace(),
    folioParameters.agent(),
    folioParameters.branch(),
    string(name: "source_db", defaultValue: "ecs-snapshot.tar", description: "Source dump file name"),
    string(name: "source_db_users", defaultValue: "ecs-snapshot-users.sql", description: "Source dump file of users"),
    folioParameters.refreshParameters()
  ])
])

def date_time = LocalDateTime.now().withNano(0).toString()
String db_backup_name = params.restore_from_backup ? params.backup_name : "${params.rancher_cluster_name}-${params.rancher_project_name}-${params.tenant_id_to_backup_modules_versions}-${date_time}"
OkapiUser admin_user = okapiSettings.adminUser(username: params.admin_username, password: params.admin_password)
String postgresql_backups_directory = "ecs-snapshot"

ansiColor('xterm') {
  if (params.REFRESH_PARAMETERS) {
    currentBuild.result = 'ABORTED'
    error('DRY RUN BUILD, PARAMETERS REFRESHED!')
  }

  node(params.AGENT) {
    try {
      stage('Ini') {
        buildName params.CLUSTER + '.' + params.NAMESPACE + '.' + env.BUILD_ID
        buildDescription "cluster: ${params.CLUSTER}\n" +
          "namespace: ${params.NAMESPACE}"
      }
      stage('Checkout') {
        checkout scm
      }

      helm.k8sClient {
        psqlDumpMethods.configureKubectl(Constants.AWS_REGION, params.rancher_cluster_name)
        psqlDumpMethods.configureHelm(Constants.FOLIO_HELM_HOSTED_REPO_NAME, Constants.FOLIO_HELM_HOSTED_REPO_URL)
        try {
          if (params.restore_from_backup == false) {
            psqlDumpMethods.backupHelmInstall(env.BUILD_ID, Constants.FOLIO_HELM_HOSTED_REPO_NAME, Constants.PSQL_DUMP_HELM_CHART_NAME, Constants.PSQL_DUMP_HELM_INSTALL_CHART_VERSION, params.rancher_project_name, params.rancher_cluster_name, db_backup_name, params.tenant_id_to_backup_modules_versions, admin_user.username, admin_user.password, "s3://" + Constants.PSQL_DUMP_BACKUPS_BUCKET_NAME, postgresql_backups_directory)
            psqlDumpMethods.savePlatformCompleteImageTag(params.rancher_project_name, db_backup_name, "s3://" + Constants.PSQL_DUMP_BACKUPS_BUCKET_NAME, postgresql_backups_directory, params.tenant_id_to_backup_modules_versions)
            psqlDumpMethods.helmDelete(env.BUILD_ID, params.rancher_project_name)
            println("\n\n\n" + "\033[32m" + "PostgreSQL backup process SUCCESSFULLY COMPLETED\nYou can find your backup in AWS s3 bucket folio-postgresql-backups/" +
              "${params.rancher_cluster_name}/${params.rancher_project_name}/${db_backup_name}" + "\n\n\n" + "\033[0m")
          } else {
            psqlDumpMethods.restoreHelmInstall(env.BUILD_ID, Constants.FOLIO_HELM_HOSTED_REPO_NAME, Constants.PSQL_DUMP_HELM_CHART_NAME, Constants.PSQL_DUMP_HELM_INSTALL_CHART_VERSION, params.rancher_project_name, db_backup_name, "s3://" + Constants.PSQL_DUMP_BACKUPS_BUCKET_NAME, postgresql_backups_directory)
            psqlDumpMethods.helmDelete(env.BUILD_ID, params.rancher_project_name)
            println("\n\n\n" + "\033[32m" + "PostgreSQL restore process SUCCESSFULLY COMPLETED\n" + "\n\n\n" + "\033[0m")
          }
        }
        catch (exception) {
          psqlDumpMethods.helmDelete(env.BUILD_ID, params.rancher_project_name)
          println("\n\n\n" + "\033[1;31m" + "PostgreSQL backup/restore process was FAILED!!!\nPlease, check logs and try again.\n\n\n" + "\033[0m")
          throw exception
        }
      }
    } catch (exception) {
      println(exception)
      error(exception.getMessage())
    } finally {
      stage('Cleanup') {
        cleanWs notFailBuild: true
      }
    }
  }
}
