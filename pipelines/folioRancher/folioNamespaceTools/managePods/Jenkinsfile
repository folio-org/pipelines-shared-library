#!groovy

import org.folio.Constants
import org.jenkinsci.plugins.workflow.libs.Library

@Library('pipelines-shared-library@RANCHER-1983') _

properties([buildDiscarder(logRotator(numToKeepStr: '60')),
            parameters([folioParameters.cluster(),
                        folioParameters.namespace(),
                        choice(name: "ACTION", choices: ['start', 'stop', 'suspend'], description: '(Required) Choose action to perform'),
                        string(name: "AGENT", description: "Build agent", defaultValue: "rancher"),
                        folioParameters.refreshParameters()]),
            pipelineTriggers([parameterizedCron('''
                H 19 * * * * %ACTION=stop,START_TIME=19 #Europe
                H 23 * * * * %ACTION=stop,START_TIME=23 #America
                ''')])])
ansiColor('xterm') {
  if (params.REFRESH_PARAMETERS) {
    currentBuild.result = 'ABORTED'
    println('REFRESH JOB PARAMETERS!')
    return
  }
  node("${params.AGENT}") {
    try {
      stage('Checkout') {
        checkout scm
      }
      stage('managePods') {
        switch (params.ACTION) {
          case "start":
            managePods.handlePods("${params.CLUSTER}", "${params.ACTION}", "${params.NAMESPACE}")
            break
          case "stop":
            Constants.AWS_EKS_CLUSTERS.each { cluster ->
              managePods.handlePods("${cluster}", "${params.ACTION}", "${params.NAMESPACE}", "${params.START_TIME}")
            }
            break
          case "suspend":
            managePods.handlePods("${params.CLUSTER}", "${params.ACTION}", "${params.NAMESPACE}")
            break
        }
      }
    } catch (exception) {
      error(exception.getMessage())
    }
  }
}
